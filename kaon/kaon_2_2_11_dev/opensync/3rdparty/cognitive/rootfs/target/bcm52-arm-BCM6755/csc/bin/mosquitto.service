#!/bin/sh

grep -q dev /csc/version 2>/dev/null && IS_DEV=true || IS_DEV=false

MOSQUITTO_CONF_SSL=/tmp/mosquitto.conf
MOSQUITTO_CONF_NO_SSL=/tmp/mosquitto_no_ssl.conf

cat <<EOF > $MOSQUITTO_CONF_NO_SSL
log_dest syslog
connection_messages false
user root
EOF

while true; do
    ROOT_MODE=$(/usr/opensync/tools/ovsh -r s Node_State -w module==motion80211 -w key==root_mode value)
    if [ ! -z $ROOT_MODE ]; then
        if [ $ROOT_MODE == 2 ]; then
            if [ -f /data/csc_gatekeeper ]; then
                MOSQUITTO_CONF=$MOSQUITTO_CONF_NO_SSL
            else
                grep -q user $MOSQUITTO_CONF_SSL || echo -e "\nuser root" >> $MOSQUITTO_CONF_SSL
                if $IS_DEV; then
                    grep -q "listener 1883" $MOSQUITTO_CONF_SSL || echo "listener 1883" >> $MOSQUITTO_CONF_SSL
                fi
                MOSQUITTO_CONF=$MOSQUITTO_CONF_SSL
            fi
            # This is the root node - run mosquitto
            logger Starting mosquitto...
            /csc/bin/mosquitto -c $MOSQUITTO_CONF
        else
            # Non-root node
            sleep 60
        fi
    else
        # OVSDB not populated yet
        sleep 5
    fi
done >/dev/null 2>/dev/null
