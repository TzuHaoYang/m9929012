#!/bin/sh

grep -q dev /csc/version 2>/dev/null && IS_DEV=true || IS_DEV=false

$IS_DEV && echo csi-p-$(nvram get et0macaddr | tr -d :) > /proc/sys/kernel/hostname

while true; do
    # wait for internet and ntp sync
    while [ -z "$(/usr/opensync/tools/ovsh s -r AWLAN_Node manager_addr)" ]; do sleep 5; done
    killall -9 micropython
    sleep 5

    # wait for rx_motion
    while true; do
        echo "vif" | nc 127.0.0.1 6970 2>/dev/null | grep -q 'wl[0-2]' && break
        sleep 1
    done

    /csc/bin/micropython -m plume_bcm 2>&1 | logger -t borg
    sleep 10
done >/dev/null 2>/dev/null
