#!/bin/sh

if [ $# -ne 1 ];
then
    echo "Usage: `basename $0` <rootfs-path>"
    exit 1
fi

ROOTFS=$1

RCD_TARGET_DIR=${RCD_TARGET_DIR:="rc3.d"}

service_get_start()
{
    START=$(sed -n '/^#*START=/{s/^.*=//;p;q}' < "${ROOTFS}/etc/init.d/$SERVICE")
    if [ -z "$START" ]; then
        echo "*** ERROR service $SERVICE unknown START level"
        exit 1
    fi
}

service_enable()
{
    SERVICE="$1"
    service_get_start
    echo "*** enable service $SERVICE ($START)"
    sed -i 's/^#START/START/' "${ROOTFS}/etc/init.d/$SERVICE"
    ln -sf "../init.d/$SERVICE" "${ROOTFS}/etc/${RCD_TARGET_DIR}/S${START}$SERVICE"
}



echo "###### post-install ${ROOTFS} #######"

mkdir -p ${ROOTFS}/overlay
mkdir -p ${ROOTFS}/rom
mkdir -p ${ROOTFS}/rootfs_data
mkdir -p ${ROOTFS}/root

##
# Version
#
ln -sf "${INSTALL_PREFIX:1}/.version" "${ROOTFS}/.version"

##
# System services
#
ln -sf ../init.d/boot ${ROOTFS}/etc/rc3.d/S26boot
ln -sf ../init.d/boot ${ROOTFS}/etc/rc3.d/K26boot
ln -sf ../init.d/wpd ${ROOTFS}/etc/rc3.d/S29wpd
ln -sf ../init.d/syslogd ${ROOTFS}/etc/rc3.d/S28syslogd
ln -sf ../init.d/htpdate ${ROOTFS}/etc/rc3.d/S49htpdate
ln -sf ../init.d/debugnet ${ROOTFS}/etc/rc3.d/S50debugnet
ln -sf ../init.d/dropbear ${ROOTFS}/etc/rc3.d/S51dropbear
ln -sf ../init.d/firewall ${ROOTFS}/etc/rc3.d/S60firewall
ln -sf ../init.d/fan ${ROOTFS}/etc/rc3.d/S60fan
ln -sf ../init.d/bcreset ${ROOTFS}/etc/rc3.d/S962bcreset


##
# BCM
#
ln -sf ../init.d/bcm_perf_boost ${ROOTFS}/etc/rc3.d/S48bcm_perf_boost

##
# OpenSync
#
ln -sf ../init.d/openvswitch ${ROOTFS}/etc/rc3.d/S90openvswitch
ln -sf ../init.d/opensync ${ROOTFS}/etc/rc3.d/S99opensync

service_enable healthcheck
test "$CONFIG_BCM_USE_HOSTAP" = y || rm -vf "$ROOTFS${INSTALL_PREFIX}/scripts/healthcheck.d/"*hostap*

# Override the system's reboot command if CONFIG_OSP_REBOOT_CLI_OVERRIDE is set
if [ "$CONFIG_OSP_REBOOT_CLI_OVERRIDE" = y ]
then
    ln -sf "${INSTALL_PREFIX}/tools/preboot" "${ROOTFS}/sbin/reboot"
fi
