<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>WLAN Speed Test</title>
    <meta HTTP-EQUIV='Pragma' CONTENT='no-cache'>
    <link rel="stylesheet" href='stylemain.css' type='text/css'>
    <link rel="stylesheet" href='colors.css' type='text/css'>
    <link class="include" rel="stylesheet" type="text/css" href="jquery.jqplot.min.css">
    <script class="include" type="text/javascript" src="gauge2.min.js"></script>
    <h1 style="margin-left: 100px; font-size: 40px"> Flow statistics</h1>
</head>
<style>
span.closebutton {
    float:right;
    display:inline-block;
    padding:2px 5px;
    background:#ccc;
}

span.closebutton:hover {
    float:right;
    display:inline-block;
    padding:2px 5px;
    background:#ccc;
    color:#fff;
}
</style>
<body onload="LoadFunction()">
    <div id='gauges-pane'>
    </div>
    <template id="gauge-template">
    <div id="gauge-block" style="position:relative; display:inline-block; width:250px; height:250px">
        <div style="position:absolute; top:0px; left:240px;">
            <span class='closebutton' id='gauge-close' onclick="CloseGauge(this)">x</span>
        </div>
        <canvas id="canv-gauge"></canvas>
        <h2 style="text-align:center">Template</h2>
    </div>
    </template>
    <br> <h2> Create new query </h2>
<div id='query-input' style="position:relative; display:inline-block;">
    <table id='query-input-tbl' cellspacing="0" cellpadding="3" border="1">
        <tr>
            <th>Parameter</th>
            <th>Value</th>
        </tr>
        <tr>
            <td><select id="query_type" size=1>
                  <option id='srcphy' value='srcphy'> Interface RX </option>
                  <option id='dstphy' value='dstphy'> Interface TX </option>
                  <option id='srcv4' value='srcv4'> Source IPv4 </option>
                  <option id='dstv4' value='dstv4'> Destination IPv4 </option>
                  <option id='srcport' value='srcport'> Source port </option>
                  <option id='dstport' value='dstport'> Destination port </option>
                  <option id='srcv6' value='srcv6'> Source IPv6 </option>
                  <option id='dstv6' value='dstv6'> Destination IPv6 </option>
                  <option id='srcipver' value='srcipver'> Source IP version </option>
                  <option id='dstipver' value='dstipver'> Destination IP version </option>
                  <option id='proto' value='proto'> Protocol number </option>
                  <option id='invid' value='invid'> Incoming VID </option>
                  <option id='outvid' value='outvid'> Outgoing VID </option>
                  <option id='srcmac' value='srcmac'> Source MAC </option>
                  <option id=dstmac'' value='dstmac'> Destination MAC </option>
                  <option id='inrxsrcmac' value='inrxsrcmac'> RX L2 GRE internal source MAC </option>
                  <option id='inrxdstmac' value='inrxdstmac'> RX L2 GRE internal destination MAC </option>
                  <option id='intxsrcmac' value='intxsrcmac'> TX L2 GRE internal source MAC </option>
                  <option id='intxdstmac' value='intxdstmac'> TX L2 GRE internal destination MAC </option>
                </select></td>
            <td class='hd'><input type='text' id="query_value"></td>
            <td><center><button onclick='btnQueryAdd()'>Add</button></center></td>
        </tr>
    </table>
</div>
<style type="text/css">
body {
  width: 1280px;
  height: 720px;
}
</style>
<script>
/** Testet with:
 *  - IE 5.5, 7.0, 8.0, 9.0 (preview)
 *  - Firefox 3.6.3, 3.6.8
 *  - Safari 5.0
 *  - Chrome 5.0
 *  - Opera 10.10, 10.60
 */
 var ws_speed_service;
 var radials_arr = [];
 var updateTimerId;
 var scale_1g = ['0','100','200','300','400','500','600','700','800','900','1000'];
 var scale_10g = ['0','1000','2000','3000','4000','5000','6000','7000','8000','9000','10000'];

 function get_appropriate_ws_url()
 {
     var pcol;
     var u = document.URL;

     if (u.substring(0, 5) == "https") {
         pcol = 'wss://';
         u = u.substr(8);
         } else {
         pcol = 'ws://';
         if (u.substring(0, 4) == "http")
         u = u.substr(7);
     }

     u = u.split('/');

     //':7681/';
     return pcol + u[0] + ':7681/';
 }

 function LoadFunction()
 {
      try {
          if (typeof MozWebSocket != 'undefined')
          {
              ws_speed_service = new MozWebSocket(get_appropriate_ws_url(), 'flowstats');
          }
          else
          {
              ws_speed_service = new WebSocket(get_appropriate_ws_url(), 'flowstats');
          }

          ws_speed_service.onopen = function ()
          {
              console.log("onload: setting timer");
              updateTimerId = setInterval(updateTimer, 2000);
          }

          ws_speed_service.onmessage = function (msg)
          {
            console.log ('Message = ' + msg.data);
            if (msg.data.startsWith("Update="))
            {
                var result = msg.data.replace("Update=","").split("|");
                var i = 0;

                while (i < result.length - 1)
                {
                    var id = result[i];
                    var net = (result[i+1] * 8)/1000000;

                    console.log ("radials_arr[", id, "].value = ", parseFloat(net));
                    radials_arr[id].value = parseFloat(net);
                    i += 2;
                }
            }
            else if (msg.data.startsWith("CreateAck="))
            {
                console.log(msg.data);
                var params = msg.data.replace("CreateAck=","").split("|");
                var id = params[0];
                var name = params[1];
                var scale = params[2];
                var radial = GaugeCreate(id, name, scale_1g);

                /* Remove just created query from the table */
                btnQueryClear();

                console.log("Creating Gauge: ID ", id, "Name: ", name, "Scale: ", scale)
                radials_arr[id] = radial;
                radial.draw();
            }
            else if (msg.data.startsWith("Error="))
            {
                alert('Error' + msg.data.replace("Error=",""));
            }
         }
     }
     catch(exception)
     {
         var e = document.getElementById("dstphy");
         var name = "Test Gauge";

         var g = GaugeCreate(0, name, scale_1g);
         g.draw();
     }
  }

  function GaugeCreate(id, name, scale)
  {
      var pane = document.getElementById("gauges-pane");
      var gauge_block = document.getElementById('gauge-template').content.cloneNode(true);
      var canvas = gauge_block.querySelector("canvas");

      canvas.id += id;
      gauge_block.querySelector("div").id += id;
      gauge_block.querySelector("span").setAttribute("data-id", id);
      gauge_block.querySelector("h2").innerHTML = name;
      document.getElementById("gauges-pane").appendChild(gauge_block);

      var radial = new RadialGauge({
          renderTo: canvas,
          width: 250,
          height: 250,
          units: 'Mbits/s',
          minValue: 0,
          maxValue: 1000,
          borders: true,
          majorTicks: scale,
          minorTicks: 2,
          strokeTicks: false,
          highlights: [
          { from: 0, to: 300, color: 'rgba(255,0,0,.6)' },
          { from: 300, to: 700, color: 'rgba(255,102,0,.8)' },
          { from: 700, to: 1000, color: 'rgba(40,100,0,1)' }],
          fontNumbersSize:16,
          colorPlate: '#333',
          colorMajorTicks: '#f5f5f5',
          colorMinorTicks: '#ddd',
          colorTitle: '#fff',
          colorUnits: '#ccc',
          colorNumbers: '#eee',
          colorNeedle: 'rgba(240, 128, 128, 1)',
          colorNeedleEnd: 'rgba(255, 160, 122, .9)',
          valueBox: true,
          valueTextShadow: true,
          animation: true,
          animationRule: 'linear',
          animationDuration: 500,
          animateOnInit: false,
          value: 0
      });

      return radial;
};

function btnQueryAdd()
{
    var table = document.getElementById("query-input-tbl");
    var query_type = document.getElementById("query_type");
    var query_value = document.getElementById("query_value");
    var row = table.insertRow();

    var cell0 = row.insertCell(0);
    cell0.setAttribute("class", "hd");
    cell0.innerHTML =  query_type.options[query_type.selectedIndex].innerHTML;
    cell0.setAttribute("data-value", query_type.options[query_type.selectedIndex].value);

    row.insertCell(1).innerHTML = '<input type="text" value="' + query_value.value + '">';
    if(row.rowIndex == 2)
    {
        var cell = row.insertCell(2);

        cell.innerHTML = '<center><button onclick="btnQueryCreate()">Create</button></center><br><br>';
        cell.innerHTML += '<center><button onclick="btnQueryClear()">Clear</button></center>';
        cell.innerHTML += '<br><br><center>Query name:<br><input type="text" id="query_name" value="Query1" onkeypress=noWhiteSpaces(event)></center>';
    }
    else
        table.rows[2].cells[2].rowSpan += 1;
    console.log("added");
}

function btnQueryCreate()
{
      var cmd = "Create ";
      var table = document.getElementById("query-input-tbl");

      cmd += document.getElementById("query_name").value;
      for (var i = 2, row; row = table.rows[i]; i++)
          cmd += " " + row.cells[0].getAttribute("data-value") + " " + row.cells[1].querySelector("input").value;
      console.log("Sending command: ", cmd);
      ws_speed_service.send(cmd);
}

function btnQueryClear()
{
    var table = document.getElementById("query-input-tbl");
    for (var row; row = table.rows[2]; table.deleteRow(2));
}

function updateTimer()
{
    ws_speed_service.send('Update?');
}

function CloseGauge(elem)
{
    var id = elem.getAttribute("data-id");
    ws_speed_service.send("Delete " + id);
    console.log("Sending message: Delete ", id);

    var gb = document.getElementById("gauge-block" + id);
    document.getElementById("gauges-pane").removeChild(gb);
}

function noWhiteSpaces(event)
{
     var key = event.keyCode; if (key === 32) event.preventDefault();
}

</script>
</body>
</html>
