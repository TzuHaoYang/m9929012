#!/bin/sh

export LOG_PROCESS="healthcheck"
[ -z "$LOG_MODULE" ] && export LOG_MODULE="MAIN"

DIR=$(dirname "$(readlink -f "$0")")

OVSH=$DIR/../tools/ovsh

. "$DIR"/log.funcs.sh

Healthcheck_Fail() {
    exit 1
}

Healthcheck_Pass() {
    exit 0
}

ovsdb_upgrade_status()
{
    $OVSH -o "%d" s AWLAN_Node upgrade_status 2> /dev/null || echo -1
}


Healthcheck_Fatal() {
    no_fatal=""
    for x in /tmp/cm-idle /etc/factory /opt/tb/cm-disable-fatal; do
        if [ -f $x ]; then
            no_fatal="$x"
            break
        fi
    done

    # safeupdate is running -- we should prevent reboots
    [ -z "$no_fatal" ] && {
        pgrep bcm_flasher > /dev/null && no_fatal="bcm_flasher"
    }

    # Firmware is downloading or being flashed, do not reboot
    [ -z "$no_fatal" ] && {
        UST=$(ovsdb_upgrade_status)
        [ ${UST} -gt 0 ] && no_fatal="upgrade"
    }

    {% raw -%}
    if [ ${#no_fatal} -gt 0 ]; then
        log_emerg "### Healthcheck Fatal: Not rebooting due to $no_fatal"
        return
    fi
    {%- endraw %}

    log_emerg "### Healthcheck Fatal: Rebooting pod ###"
    sleep 5 # Give LM a chance to collect logs
    /sbin/reboot
}
